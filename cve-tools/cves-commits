#!/bin/bash

here=`dirname $0`
case "$here" in
/*) ;;
*)  here="`pwd`/$here" ;;
esac

sha1="[0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f]"
sha1="$sha1[0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f]"
sha1="$sha1[0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f]"
sha1="$sha1[0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f]"

prefix=`dirname "$1"`

cat "$@" |
	awk '
		BEGIN				{ chk = 0; cve="BEGIN" }
		/^Candidate:/			{ if (shas != "") { print cve shas };
						  chk = 0; cve="'"$prefix"'/" $2; shas=""; next }
		/^Patches_linux/		{ match($0, "^Patches_(.*):", m); pkg = m[1]; chk = 1; next }
		(chk == 0)			{ next }
		/^ upstream:/			{ shas=shas " " pkg ":" $2 }
		(/^ [bB]reak-[fF]ix:/ && $3 != "-")	{ shas=shas " " pkg ":" $2 ">" $3 }
		END				{ if (shas != "") { print cve shas } }
	' | sed -e 's@http://git.kernel.org/[^>]*[/=]@@g'
