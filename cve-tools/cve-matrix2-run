#!/bin/bash -x

here=$(dirname "$(readlink -f "${0}")")

out="$HOME/cve-matrix"
mkdir -p "$out"

cd "$out" || exit 1

export http_proxy="http://squid.internal:3128"
export https_proxy="https://squid.internal:3128"
export no_proxy="launchpad.net,.launchpad.net,kernel.ubuntu.com"

# Ensure we have a copy of ubuntu-cve-tracker
if [ ! -d "ubuntu-cve-tracker" ]; then
	git clone lp:~canonical-kernel-team/ubuntu-cve-tracker
fi
(
	cd ubuntu-cve-tracker || exit 1
	git fetch origin
	git reset --hard origin/for-security
)

# Ensure we have a copy of ubuntu-security-customer-ppa-tracking.
if [ ! -d "ubuntu-security-customer-ppa-tracking" ]; then
	git clone lp:~canonical-kernel-team/ubuntu-security-customer-ppa-tracking
fi
(
	cd ubuntu-security-customer-ppa-tracking || exit 1
	git fetch origin
	git reset --hard origin/for-security
)


"$here/cve-matrix2" \
	--primary $out/ubuntu-cve-tracker/active \
	--overlay $out/ubuntu-security-customer-ppa-tracking/ibm-cloud \
	$HOME/xfer-private/cve-matrix-internal/index.html
