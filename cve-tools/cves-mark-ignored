#!/bin/bash

shopt -s extglob

here=`dirname $0`
case "$here" in
/*) ;;
*)  here="`pwd`/$here" ;;
esac

if [ "$#" -lt 2 ]; then
	echo "Usage: $0 <config> <devel release> <cves>" 1>&2
	exit 1
fi
config="$1"
devel="$2"
shift 2

while read series cvebranch repo branch flags X
do
	case ",$flags," in
	*,mark-ignored,*)	;;
	*)			continue ;;
	esac

	mim=",${flags},"
	mim="${mim#*,mark-ignored-message:}"
	mim="${mim%%,*}"
	[ "$mim" != "" ] && mim=" ${mim}"
	mim=`echo "$mim" | sed -e 's/%s/ /g' -e 's/%%/%/g'`

	echo "$series $cvebranch (ignored$mim) ..." 1>&2

	if [ "$series" = "$devel" ]; then
		series="devel"
	fi

	egrep -H "^${series}_${cvebranch}: *(needs-triage|needed|pending|deferred)" "$@" |\
	while IFS=: read cve series_branch state
	do
		notes="${state%% }"		# string surrounding whitespace
		notes="${notes## }"
		notes="${notes//\(/\[}"		# encode internal parentheis
		notes="${notes//\)/\]}"
		echo "$cve $series $cvebranch - ignored was $notes$mim"
	done
done <"$config" | "$here/cves-tracker-update2" --direct-copy "$devel"
