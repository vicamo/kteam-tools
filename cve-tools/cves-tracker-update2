#!/usr/bin/python
#
# cves-tracker-update -- merge tracker updates
#
from __future__ import print_function

import os
import sys

devel = sys.argv[1]

default_to_change = { 'active', 'needs-triage', 'needed', 'pending', 'released', 'not-affected' }
#default_to_change = { 'active', 'needs-triage', 'needed' }

def update_entry(cve, entry):
    #print("apply", cve)

    cur = []
    new = []

    with open(cve, "r") as cfd:
        for line in cfd:
            line = line.rstrip('\n')
            cur.append(line)
            new.append(line)

            line_bits = line.split(':')
            if len(line_bits) != 2:
                continue
            
            (line_item, line_data) = line_bits
            if line_item not in entry:
                continue

            line_data_bits = line_data.split(None, 1) + [ '' ]
            if len(line_data_bits) < 2:
                continue
            (line_state, line_annot) = line_data_bits[0:2]

            # DNE entries are as if they are not present.  deferred and ignored
            # are manual states.
            if line_state in ('DNE', 'deferred', 'ignored'):
                continue

            # We only every update entries if they have a version in them, those
            # with words in are assumed set by a human.
            if len(line_annot) >= 2 and line_annot[1].isalpha():
                continue

            if len(line_annot) >= 3:
                line_annot = line_annot[1:-1]

            # Work out the new state and annotation -- all upstream entries are the same.
            (new_state, new_annot) = (line_state, line_annot)
            if line_item.startswith('upstream_'):
                (ent_state, ent_annot) = entry['upstream_linux']
            else:
                (ent_state, ent_annot) = entry[line_item]

            if ent_state == 'needs-triage':
                if line_state in [ 'active', 'needs-triage', 'pending', 'released' ]:
                    (new_state, new_annot) = (ent_state, '')

            elif ent_state == 'needed':
                #if line_state in default_to_change:
                    (new_state, new_annot) = (ent_state, '')

            elif ent_state == 'not-affected' and ent_annot in ('-', 'pending'):
                #if line_state in default_to_change:
                    (new_state, new_annot) = (ent_state, '')
                
            elif ent_state == 'not-affected':
                if line_item.startswith('upstream_'):
                    (new_state, new_annot) = ('released', ent_annot)
                else:
                    #if line_state in default_to_change:
                        (new_state, new_annot) = (ent_state, ent_annot)
                
            elif ent_state == 'released' and ent_annot == 'pending':
                #if line_state in default_to_change:
                    (new_state, new_annot) = ('pending', '')

            elif ent_state == 'released':
                if line_item.startswith('upstream_'):
                    (new_state, new_annot) = ('released', ent_annot)
                elif (line_state not in ['not-affected', 'released', 'pending'] or
                    line_annot != ent_annot):
                    (new_state, new_annot) = ('pending', ent_annot)
                        
            else:
                continue

            if (line_state, line_annot) != (new_state, new_annot):
                new_line = line_item + ': ' + new_state
                if new_annot != '':
                    new_line += ' (' + new_annot + ')'
                new.pop()
                new.append(new_line)
                print(cve, line_item, (ent_state, ent_annot), (line_state, line_annot), '=>', (new_state, new_annot))
                print('-', line)
                print('+', new_line)

    if cur != new:
        with file(cve + '.new', 'w') as nfd:
            print('\n'.join(new), file=nfd)
        os.rename(cve + '.new', cve)


cve = None
cve_prev = None
entry = {}

for line in sys.stdin:
    (cve, series, package, shas, state, version) = line.strip().split()
    if cve_prev and cve_prev != cve:
        update_entry(cve_prev, entry)
        entry = {}
    cve_prev = cve

    # In active CVEs we can update devel.
    if not cve.startswith('retired/'):
        if series == devel:
            series = 'devel'

    entry[series + '_' + package] = (state, version)
if cve_prev:
        update_entry(cve_prev, entry)

