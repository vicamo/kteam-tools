#!/bin/bash

default_to_change="\\(active\\|needs-triage\\|needed\\|pending\\|released\\|not-affected\\)"
case "$1" in
--rebase)
	default_to_change="\\(active\\|needs-triage\\|needed\\)"
	shift
	;;
esac

if [ "$#" -ne 2 ]; then
	echo "Usage: $0 <devel> <cve-tracker-file>" 1>&2
	exit 1
fi
devel="$1"
file="$2"

cmd="sed -i '$file'"
while read series branch commit version
do
	[ "$version" = "" ] && continue
	#version=`echo "$version" | sed -e 's/~.*//'`

	if [ "$series" = "$devel" ]; then
		series='devel'
	fi

	to_change="$default_to_change"
	if [ "$version" = 'needs-triage' ]; then
		test_state='needs-triage'
		set_state='needs-triage'
		to_change="\\(active\\|needs-triage\\|pending\\|released\\)"
	elif [ "$version" = 'pending' ]; then
		test_state='pending'
		set_state='pending'
	elif [ "$version" = 'not-affected' ]; then
		test_state='not-affected'
		set_state='not-affected'
	elif [ "$version" = 'needed' ]; then
		test_state='needed'
		set_state='needed'
	else
		test_state="\\(released\\|not-affected\\)\\s\\s*($version)\\s*"
		if [ "$series" = "upstream" ]; then
			set_state="released ($version)"
		else
			set_state="pending ($version)"
		fi
	fi

	case "$series-$branch" in
	upstream-linux)
		# Simply inject the upstream version -- everywhere.
		package_pat="\\(upstream_linux.*:\\)"
		;;
	*)	
		package_pat="\\(${series}_$branch:\\)"
		;;
	esac

	# If we are released and the version is correct we want to leave the line alone
	# _otherwise_ we want to move it pending (version) so it can be detected upstream.
	cmd="$cmd -e 's/^$package_pat not-affected\\(\s.*([A-Za-z].*\\)/\\1 NOT-AFFECTED\\2/'"
	cmd="$cmd -e 's/^$package_pat \\($test_state\\)$/\\1 __CORRECT__ \\2/'"
	cmd="$cmd -e 's/^$package_pat $to_change\\(.*\\)/\\1 $set_state/'"
	cmd="$cmd -e 's/^$package_pat __CORRECT__/\\1/'"
	cmd="$cmd -e 's/^$package_pat NOT-AFFECTED\\(\s.*([A-Za-z].*\\)/\\1 not-affected\\2/'"
done

#echo "$cmd"
eval "$cmd"
