#!/bin/bash

repos="$HOME/cve-autotriage"

work="$1"

# Ensure all upstream repositories exist.
echo "*** creating missing repos ... " 1>&2
while read series cvebranch repo branch flags tos url X
do
	(
		if [ "$url" = '-' -o "$url" = '' ]; then
			exit 0
		fi

		echo "*** checking $repo ..."
		remote='origin'
		cd "$repos" || exit 1
		if [ ! -d "$repo" ]; then
			echo "*** cloning $repo ..."
			if [ "$repo" != "linux-linus.git" ]; then
				git clone --bare --reference linux-linus.git "$url" "$repo"
			else
				git clone --bare "$url" "$repo"
			fi
		fi
		cd "$repo" || exit 1

		rc=0
		curr=`git config "remote.$remote.url"` || rc=1
		if [ "$rc" -eq 0 -a "$curr" != "$url" ]; then
			echo "*** removing $remote remote ($curr) ..."
			git remote rm "$remote" || true
			curr=""
		fi
		if [ "$curr" = "" ]; then
			echo "*** adding $remote remote ($url) ..."
			git remote add "$remote" "$url"
		fi
	) 1>&2
done <"$work"


