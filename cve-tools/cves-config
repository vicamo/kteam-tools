#!/usr/bin/python
from __future__ import print_function

import sys

from ktl.kernel_series import KernelSeries

kernel_series = KernelSeries()

# Commands: primary|removals
cmd = sys.argv[1]

upstreams = []
derived = {}
upstream_derived = {}
for series in sorted(kernel_series.series, key=KernelSeries.key_series_name):
    if not series.opening_ready('repositories'):
        continue
    if not series.supported and not series.development:
        continue
    for source in sorted(series.sources, key=lambda x: x.name):
        if not source.supported and not series.development:
            continue

        for connected in (source.derived_from, source.copy_forward):
            while connected:
                primary = derived.setdefault((connected.series.name, connected.name), [])
                if source not in primary:
                    primary.append(source)
                connected = connected.derived_from

        versions = source.versions
        if versions:
            version = versions[-1]
            if version not in upstreams:
                upstreams.append(version)
            upstream_derived.setdefault(version, []).append(source.series.codename + '_' + source.name)

upstreams = sorted(upstreams, key=lambda x: [ int(y) for y in x.split('.') ])

# We always want to scan linus' tree.
if cmd == 'primary':
    print("upstream linux linux-linus.git master scan,tags-git:v* - git://git.launchpad.net/~ubuntu-kernel-test/ubuntu/+source/linux/+git/linus--linux")

url = 'git://kernel.ubuntu.com/kernel-ppa/stable-queue-branches.git'
for version in upstreams:
    version_short = version
    if version_short.endswith('.0'):
        version_short = version_short[:-2]

    if cmd == 'primary':
        print("upstream linux-{version_short} stable-queue-branches.git stable-queue-{version_short} scan,tags-git:v{version_short}.*,transfer-pending:{transfer},transfer-message:in%s%v,transfer-message-tip:in%s{version_short}.y%squeue - {url}".format(version_short=version_short, url=url, transfer="|".join(upstream_derived[version])))
    url='-'

flags_eol = 'mark-ignored,mark-ignored-message:now%send-of-life'
flags_unsupported = 'scan,tags-lp,mark-pockets,unsupported'

urls_seen = {}
for series in sorted(kernel_series.series, key=KernelSeries.key_series_name):
    if not series.opening_ready('repositories'):
        continue
    for source in sorted(series.sources, key=lambda x: x.name):
        url = '-'
        branch = '-'

        # Find the matching package for this source -- if there is not
        # one found this is likely a -meta only branch.
        package = source.lookup_package(source.name)
        if not package:
            if not source.derived_from:
                continue
        if package and package.repo:
            (url, branch) = (package.repo.url, package.repo.branch)

        # Support package in a supported series, which is meta only.
        if source.name == "linux-azure-fde" or (source.supported and (series.supported or series.development) and not package):
            flags = 'mark-pockets,unsupported,metaonly-link:{}_{}'.format(source.derived_from.series.codename, source.derived_from.name)

        # Supported package in a supported series.
        elif (source.supported and series.supported) or series.development:
            flags = 'scan,tags-lp,mark-pockets'
            derived_key = (source.series.name, source.name)
            if derived_key in derived:
                result = []
                for derived_source in derived[derived_key]:
                    result.append("{}_{}".format(derived_source.series.codename, derived_source.name))
                if len(result) > 0:
                    found_in = "{}%s{}".format(source.series.codename, source.name)
                    flags += ",transfer-pending:{targets},transfer-message:@pending%spending%srebase%s{source},transfer-message-tip:@pending%sin%s{source}".format(targets="|".join(result),source=found_in)

        # A completely dead series.
        else:
            flags = flags_eol
            url = '-'
            branch = '-'

        if url == '-':
            repo = '-'
        else:
            #variant = source.name
            #if variant.startswith('linux'):
            #    variant = variant[5:]
            #repo = "ubuntu-{series}{variant}.git".format(series=source.series.codename, variant=variant)
            repo = "{series}-{source}.git".format(series=source.series.codename, source=source.name)
            if url in urls_seen:
                repo = urls_seen[url]
                url = '-'
            else:
                urls_seen[url] = repo

        series_codename = series.codename
        if flags != flags_unsupported and flags != flags_eol:
            if cmd == 'primary' and series.esm:
                print("{series} {source} {repo} {branch} {flags} - {url}".format(series=source.series.codename, source=source.name, branch='-', flags='mark-ignored,mark-ignored-message:now%send-of-life', url='-', repo='-'))

            if series.esm or source.severe_only:
                flags = flags + ',mark-esm'

            if series.esm:
                if series_codename in ('precise', 'trusty'):
                    series_codename = series_codename + '/esm'
                else:
                    series_codename = 'esm-infra/' + series_codename

                # Build a string such as 'archives:ubuntu|security/updates-ppa:ubuntu-esm/ubuntu/esm-infra-security|proposed-ppa:canonical-kernel-esm/ubuntu/proposed|ppa:canonical-kernel-esm/ubuntu/ppa'
                archives = None
                for (destination_name, archive_name) in [('release',  None),
                                                         ('updates',  'security/updates'),
                                                         ('proposed', 'proposed'),
                                                         ('build',    None)]:
                    destination = source.routing.lookup_destination(destination_name, primary=True)
                    if destination:
                        if not archives:
                            archives = 'archives:'
                        else:
                            archives += '|'
                            if archive_name:
                                archives += archive_name + '-'
                        archives += destination[0]

                if archives:
                    flags = flags + ',' + archives

        if cmd == 'primary':
            print("{series} {source} {repo} {branch} {flags} - {url}".format(series=series_codename, source=source.name, branch=branch, flags=flags, url=url, repo=repo))
        elif cmd == 'removals':
            if ',scan,' not in ',' + flags + ',':
                print("update TagDetail set Valid=0 where series='{series}' and source='{source}';".format(series=series_codename, source=source.name))

if cmd == 'primary':
    print("{series} {source} {repo} {branch} {flags} - {url}".format(series='product', source='linux-krillin', branch='-', flags=flags_eol, url='-', repo='-'))
    print("{series} {source} {repo} {branch} {flags} - {url}".format(series='product', source='linux-vegetahd', branch='-', flags=flags_eol, url='-', repo='-'))
