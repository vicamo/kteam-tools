#!/usr/bin/bash

here=$(dirname "$(readlink -f "${0}")")

if [ "$#" -ne 0 -a "$#" -ne 1 ]; then
	echo "Usage: $0 [<target branch>]" 1>&2
	exit 1
fi
if [ "$#" -lt 1 ]; then
	set - origin/autotriage
fi

target="$1"

diff="/tmp/integrate.patch.$$"

extract_active()
{
	git diff .."$target" active | "$here/extract-something" "$@" >>"$diff"
}

extract_flat()
{
	git diff .."$target" ibm-cloud | "$here/extract-something" "$@" >>"$diff"
}

if [ -d "active" ]; then
	extract()
	{
		extract_active "$@"
	}
else
	extract()
	{
		extract_flat "$@"
	}
fi

commit()
{
	echo "$@" | head -1
	if [ -s "$diff" ]; then
		git apply --index <"$diff"
		git commit --author "Kernel CVE Autotriage <ubuntu-kernel-bot+cve-autotriage@canonical.com>" -a -s -m "$@"
	fi
	rm -f "$diff"
}

commit_individual()
{
	echo "$@" | head -1
	if [ -s "$diff" ]; then
		git apply <"$diff"
		for cve in $(lsdiff "$diff")
		do
			git commit -s -m "${@/@CVE@/${cve##*/}}" "${cve#*/}"
		done
	fi
	rm -f "$diff"
}

squash()
{
	git -c core.editor=: commit -a -s --ame
}

# Grab the current autotriage data.
git fetch origin

main=$(git for-each-ref refs/heads/main)
if [ "$main" ]; then
	origin_branch="main"
else
	origin_branch="master"
fi
if [ -d "active" ]; then
	base="origin/autotriage~2"
else
	base="origin/autotriage~1"
fi

# FOR SECURITY: Build the for-security branch.
git checkout -B integrate/for-security "$base"

extract --phase between --against upstream --right released
commit "\
House Keeping: upstream version updates

Update all of the current upstream versions including references to the stable
branches in which the fixes were found.
"

extract --phase between --left needs-triage --right needed
commit "\
House Keeping: changes now known and needed

Accept all change triggered by adding break-fix data.
"

extract --phase between --left needs-triage --right needs-triage
extract --phase between --left needed --right needed
commit "\
House Keeping: ESM/EOL priority changes triggered transitions in and out of ignored

States changing because the priority of an ESM tracker has changes allowing to
enter or leave ignored but in the same nominal state.  These are benign and
auto-reversible.
"

extract --phase between --left DNE --right ignored
commit "\
House Keeping: state changes DNE to ignored

When the boilerplate for a kernel changes to switch it out of DNE
this is honoured and applied to all CVEs.
"

extract --phase between --left not-affected --right not-affected
commit "\
House Keeping: version changes in not-affected

We are updating a kernel from not-affected either without a version or with
an incorrect version to the now correct version.  None of these are significant
because both versions were versions before the release version and so no USN
updates are needed.
"

extract --phase between --left released --right released
commit "\
House Keeping: version changes in released

We are updating a kernel version in released but remaining in released.  This
tells us the kernel is actually not supported and so no USN will be needed.
"

extract --phase between --left released --right not-affected
commit "\
House Keeping: state changes released to not-affected

We are updating a kernel version from released to not-affected.  This tells us the kernel
is not affected, updates to a USN may be required.
"

extract --phase between --left not-affected --right released
commit "\
House Keeping: state changes not-affected to released

We are updating a kernel version from not-affected to released.  This tells us
the kernel actually was affect but is now fixed, it is likely unsupported and
so no USN will be needed.
"

extract --phase between --left needs-triage --left needed --left pending --right pending --right not-affected --right released
commit "\
House Keeping: patches now applied

These changes represent patches now found applied possibly with versions.
"

extract --phase between --left not-affected --right pending
commit "\
House Keeping: not-affected to pending

We are updating the kernel version from not-affected to pending.  This may
welll require a USN.
"

extract --phase between --left released --right pending --version-older
commit "\
House Keeping: released to pending at older version

We are updating the kernel version from released to pending at an older version.
This a safe but might require an updated USN.
"

extract --phase between --left released --right pending
commit "\
House Keeping: released to pending at newer version

We are updating the kernel version from released to pending at an newer version.
This needs reviing and likely requires an updated USN.
"

extract --phase between --left pending --right needed --left-reason-none --right-reason-none
commit "\
House Keeping: pending to needed without version

We are pulling a fix back from pending to needed.  We are versionless
in both cases so this will not have been reported as present.
"

extract --phase pure
commit "\
House Keeping: rejuvenated trackers

Tracker updates pulling in additional kernel stanzas.
"

# REVIEW: build the review branch.
git checkout -B integrate/review

extract --phase between --left released --left not-affected --left pending --right needed
commit_individual "\
@CVE@: upstream fixes no longer present

Upstream has dropped or reverted the fix we are expecting this needs special
review.
"

if [ -d "active" ]; then
	git diff --quiet ..origin/autotriage active || echo "WARNING: changes remain"
else
	git diff --quiet ..origin/autotriage . || echo "WARNING: changes remain"
fi

echo "Updating for-security and review results ..."
git push --force-with-lease origin integrate/for-security:for-security
git push --force-with-lease origin integrate/review:review
