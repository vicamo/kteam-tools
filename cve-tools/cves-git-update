#!/bin/bash

repos="$HOME/cve-autotriage"

work="$1"

# Fetch all of the upstream repos in parallel.
echo "*** updating all repos ..." 1>&2
prev_repo=""
while read series cvebranch repo branch flags tos url X
do
	if [ "$url" = '-' ]; then
		continue
	fi

	case "$prev_repo" in
	*,$repo,*)		continue ;;
	esac
	prev_repo="$prev_repo,$repo,"

	(
		time="$SECONDS"
		echo "*** fetching $repo ... "

		cd "$repos/$repo" || exit 1
		git fetch origin '+refs/heads/*:refs/heads/*' '+refs/tags/*:refs/tags/*'
		touch ".live"

		let time="$SECONDS-$time"
		echo "*** fetching $repo ... completed in ${time}s"
	) 1>&2
done <"$work" &

wait
