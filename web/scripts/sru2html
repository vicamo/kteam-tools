#!/usr/bin/env python3
#

from sys                                import argv
from os                                 import path
from getopt                             import getopt, GetoptError
import json
from utils                              import stdo
from std_app                            import StdApp

# CmdlineError
#
# The type of exception that will be raised by Cmdline.process() if there
# are command line processing errors.
#
class CmdlineError(Exception):
    # __init__
    #
    def __init__(self, error):
        self.msg = error

# Cmdline
#
# Do all the command line processing.
#
class Cmdline:
    # __init__
    #
    def __init__(self):
        self.cfg = {}

    # error
    #
    def error(self, e, defaults):
        if e != '':
            print(e)
        self.usage(defaults)

    # usage
    #
    # Prints out the help text which explains the command line options.
    #
    def usage(self, defaults):
        stdo("    Usage:                                                                                   \n")
        stdo("        %s [--verbose] [--config=<cfg file>] [--debug=<dbg options>] <srus.json>             \n" % self.cfg['app_name'])
        stdo("                                                                                             \n")
        stdo("    Options:                                                                                 \n")
        stdo("        --help           Prints this text.                                                   \n")
        stdo("                                                                                             \n")
        stdo("        --verbose        Give some feedback of what is happening while the script is         \n")
        stdo("                         running.                                                            \n")
        stdo("                                                                                             \n")
        stdo("        --config=<cfg file>                                                                  \n")
        stdo("                         The full path to the configuration file to use instead of           \n")
        stdo("                         the default location.                                               \n")
        stdo("                                                                                             \n")
        stdo("        --debug=<debug options>                                                              \n")
        stdo("                         Performs additional output related to the option enabled and        \n")
        stdo("                         the application defined support for the option.                     \n")
        stdo("                                                                                             \n")
        stdo("    Examples:                                                                                \n")
        stdo("        %s --verbose                                                                         \n" % self.cfg['app_name'])

    # process
    #
    # As you can probably tell from the name, this method is responsible
    # for calling the getopt function to process the command line. All
    # parameters are processed into class variables for use by other
    # methods.
    #
    def process(self, argv, defaults):
        self.cfg['app_name'] = argv[0]
        result = True
        try:
            optsShort = ''
            optsLong  = ['help', 'verbose', 'config=', 'debug=']
            opts, args = getopt(argv[1:], optsShort, optsLong)

            for opt, val in opts:
                if (opt == '--help'):
                    raise CmdlineError('')

                elif (opt == '--verbose'):
                    self.cfg['verbose'] = True

                elif opt in ('--config'):
                    self.cfg['configuration_file'] = val

                elif opt in ('--debug'):
                    self.cfg['debug'] = val.split(',')

            if result: # No errors yet

                # At lease one source package must be specified.
                #
                if len(args) > 0:
                    self.cfg['sru'] = args[0]

        except GetoptError as error:
            print(error, defaults)
            raise CmdlineError('')

        return self.cfg

    # verify_options
    #
    def verify_options(self, cfg):
        if 'sru' not in self.cfg:
            raise CmdlineError('A json file containing the sru information is required. This is generated by the sru-report script.')
        return


class SruReport:
    # __init__
    #
    def __init__(self, data):
        self.data = data

    def __str__(self):
        retval  = self.head()
        retval += self.body()
        retval += self.tail()
        return retval

    def head(self):
        return '''
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-US">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Kernel SRU Report</title>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js" type="text/javascript" charset="utf-8"></script>

        <link href='http://fonts.googleapis.com/css?family=Cantarell&subset=latin'              rel='stylesheet' type='text/css'>
        <link title="light" rel="stylesheet" href="css/light-style.css" type="text/css" media="print, projection, screen" />
        <link title="dark" rel="stylesheet" href="css/dark-style.css" type="text/css" media="print, projection, screen" />
        <script type="text/javascript" src="js/styleswitcher.js"></script>
    </head>
        '''

    def tail(self):
        return '''

</html>
        '''

    def package_type_key(self, package):
        if package.startswith('linux-signed'):
            words = 2
            order = 15

        elif package.startswith('linux-restricted-modules'):
            words = 3
            order = 40

        elif package.startswith('linux-restricted-'):
            words = 3
            order = 45

        elif package.startswith('linux-backports-modules-'):
            words = 4
            order = 60

        elif package.startswith('linux-meta'):
            words = 2
            order = 80

        elif package.startswith('linux'):
            words = 1
            order = 10

        else:
            words = 0
            order = 90

        # Form the master source package name from the suffix of the binary
        # package (a poormans ks_package.source.name).  Above we have
        # identified the length of the package type prefix, the remainder (if
        # any) represents the package suffix: linux-signed-aws -> [aws],
        # linux-meta-gcp-5.8 -> [gcp, 5.8].  Reassemble these with a linux-
        # prefix to form the kernel-series source package name.
        master_package = '-'.join(['linux'] + package.split('-')[words:])

        # Sort by the kernel-series source package, and within that order
        # packages in a consistent order as above.  Where there is any
        # ambiguity disambiguate using the full package name.
        return master_package, order, package

    def body(self):
        retval =  '''
    <body class="bugbody">
        <div class="outermost">'''
        retval += '\n'

        trackers_only_packages = ['linux-lts-backport-maverick', 'linux-lts-backport-natty', 'linux-lts-backport-oneiric', 'linux-lts-quantal']
        suite_keys = self.data['releases_order']
        for rls in suite_keys:
            if len(self.data['releases'][rls]) == 0:
                retval += "                    <div class=\"l2-section-heading\">%s</div>\n<div class=\"section\">                    No packages in proposed.</div>\n" % rls
            else:
                pkg_keys = sorted(self.data['releases'][rls].keys(), key=self.package_type_key)

                retval += "                <div class=\"l2-section-heading\">%s</div>\n" % rls
                retval += '            <div class="section">\n'
                retval += '                    <table width="100%">\n'
                retval += "                        <!--\n"
                retval += "                        <tr><th>Package</th><th>-release</th><th>-updates</th><th>-proposed</th><th>&nbsp;</th><th>days</th></tr>\n"
                retval += "                        -->\n"
                for pkg in pkg_keys:
                    if 'Proposed' not in self.data['releases'][rls][pkg]: continue

                    #lpurl = 'https://launchpad.net/ubuntu/%s/+source/%s/' % (rls, pkg)
                    pkg_id = rls + '--' + pkg
                    lpurl = 'https://launchpad.net/ubuntu/+source/%s/' % (pkg)
                    ppaurl = 'https://launchpad.net/~canonical-kernel-team/+archive/ppa/+packages'
                    retval += '                        <tr>\n'
                    retval += '                            <td width="400" valign="top"><a id="%s" href="%s"        >%s  </a></td>\n' % (pkg_id, lpurl, pkg)

                    if 'Release' not in self.data['releases'][rls][pkg] or self.data['releases'][rls][pkg]['Release'] == '':
                        retval += '                            <td width="200" valign="top">&nbsp;</td>\n'
                    else:
                        tmp = ppaurl
                        retval += '                            <td width="200" valign="top"><a href="%s" >%s</a> (-release)</td>\n' % (tmp, self.data['releases'][rls][pkg]['Release'])

                    if 'Updates' not in self.data['releases'][rls][pkg] or self.data['releases'][rls][pkg]['Updates'] == '':
                        retval += '                            <td width="200" valign="top">&nbsp;</td>\n'
                    else:
                        tmp = lpurl + self.data['releases'][rls][pkg]['Updates']
                        retval += '                            <td width="200" valign="top"><a href="%s" >%s</a> (-updates)</td>\n' % (tmp, self.data['releases'][rls][pkg]['Updates'])

                    if 'Proposed' not in self.data['releases'][rls][pkg] or self.data['releases'][rls][pkg]['Proposed'] == '':
                        retval += '                            <td width="200" valign="top">&nbsp;</td>\n'
                        proposed_version = None
                    else:
                        proposed_version = self.data['releases'][rls][pkg]['Proposed']
                        tmp = lpurl + proposed_version
                        retval += '                            <td width="200" valign="top"><a href="%s" >%s</a> (-proposed)</td>\n' % (tmp, self.data['releases'][rls][pkg]['Proposed'])
                    retval += '                            <td>&nbsp;</td>\n'
                    if 'age' not in self.data['releases'][rls][pkg]:
                        retval += '                            <td width="10">&nbsp</td>\n'
                    else:
                        retval += '                            <td width="10">%s</td>\n' % (self.data['releases'][rls][pkg]['age'])
                    retval += '                        </tr>\n'

                    if 'bugs' in self.data['releases'][rls][pkg] and len(self.data['releases'][rls][pkg]['bugs']):
                        retval += '                        <tr>\n'
                        retval += '                            <td colspan="6">\n'
                        retval += '                                <table width="100%">\n'
                        for bug in self.data['releases'][rls][pkg]['bugs']:
                            state = self.data['releases'][rls][pkg]['bugs'][bug]['state']
                            if state == 'release-tracker' or pkg not in trackers_only_packages:
                                retval += '                                   <tr>\n'
                                retval += '                                       <td width="20">\n'
                                retval += '                                           &nbsp;\n'
                                retval += '                                       </td>\n'

                                if state == 'needed':
                                    colour = '#0099ff' # Electric Blue
                                    img    = 'img/help.png'
                                    msg    = 'This bug needs to be verified'
                                elif state == 'verified':
                                    colour = '#00ff00' # Lime green
                                    img    = 'img/tick.png'
                                    msg    = 'This bug has been successfully verified'
                                elif state == 'failed':
                                    colour = '#ff0000' # Red
                                    img    = 'img/error.png'
                                    msg    = 'This bug has failed verification'
                                elif state == 'reverted':
                                    colour = '#ff0000' # Red
                                    img    = 'img/exclamation.png'
                                    msg    = 'Patch for this bug was reverted after it failed verification'
                                elif state == 'missing':
                                    colour = '#ff4500' # Vibrant orange
                                    img    = 'img/warning.png'
                                    msg    = 'This bug is missing the tags use to track verification'
                                elif state == 'release-tracker':
                                    colour = '#ffff00' # Yellow
                                    img    = 'img/zoom.png'
                                    msg    = 'This is a release-tracking bug, not needing verification'
                                elif state == 'stable-tracker':
                                    colour = '#ffff00' # Yellow
                                    img    = 'img/zoom.png'
                                    msg    = 'This is a stable-tracking bug, not needing verification'
                                elif state == 'cve-tracker':
                                    colour = '#ffff00' # Yellow
                                    img    = 'img/shield.png'
                                    msg    = 'This is a cve-tracking bug, not needing verification'
                                elif state == 'packaging-tracker':
                                    colour = '#ffff00' # Yellow
                                    img    = 'img/zoom.png'
                                    msg    = 'This is a packaging-tracking bug, not needing verification'
                                elif state == 'parent-validated':
                                    colour = '#ffff00' # Yellow
                                    img    = None
                                    msg    = 'This bug is being verified against our parent tracker'
                                else:
                                    colour = '#ffffff'
                                    img    = 'img/tux.png'
                                    msg    = 'Unable to determine the correct state for this bug'

                                # Special handling of the current tracker bug because some people seem to find it difficult
                                # to find.
                                #
                                if img is not None:
                                    col2 = '<img src="%s"></img>' % (img, )
                                else:
                                    col2 = '&mdash;'
                                if (proposed_version != None) and (proposed_version in self.data['releases'][rls][pkg]['bugs'][bug]['title']) and ('-proposed tracker' in self.data['releases'][rls][pkg]['bugs'][bug]['title']):
                                    retval += '                                       <td width="20" title="Current -proposed tracking bug" align="center"><img src="img/star.png"></img></a></td>\n'
                                    retval += '                                           &nbsp;\n'
                                    retval += '                                       </td>\n'
                                else:
                                    retval += '                                       <td width="20">\n'
                                    retval += '                                           &nbsp;\n'
                                    retval += '                                       </td>\n'

                                retval += '                                       <td width="20" title="%s" align="center">%s</a></td>\n' % (msg, col2)
                                retval += '                                       <td width="20" valign="top">\n'
                                tmp = "http://launchpad.net/bugs/%s" % bug
                                retval += '                                           <a href="%s">%s</a>\n' % (tmp, bug)
                                retval += '                                       </td>\n'
                                retval += '                                       <td valign="top">\n'
                                retval += '                                           '
                                retval += self.data['releases'][rls][pkg]['bugs'][bug]['title']
                                retval += '\n'
                                retval += '                                       </td>\n'
                                retval += '                                       <td width="150" valign="top">\n'
                                retval += '                                           '
                                retval += self.data['releases'][rls][pkg]['bugs'][bug]['owner']
                                retval += '\n'
                                retval += '                                       </td>\n'
                                retval += '                                       <td width="50">\n'
                                retval += '                                           &nbsp;\n'
                                retval += '                                       </td>\n'
                                retval += '                                   </tr>\n'
                        retval += '                               </table>\n'
                        retval += '                           </td>\n'
                        retval += '                       </tr>\n'

                retval += '                   </table>\n'
                retval += '            </div>\n'

        retval += '            <div>\n'
        retval += '                <br />\n'
        retval += '                <hr />\n'
        retval += '                <table width="100%" cellspacing="0" cellpadding="0">\n'
        retval += '                    <tr>\n'
        retval += '                        <td>\n'
        retval += '                            %s\n' % self.data['updated']
        retval += '                        </td>\n'
        retval += '                        <td align="right">\n'
        retval += '                            Themes:&nbsp;&nbsp;\n'
        retval += '                            <a href=\'#\' onclick="setActiveStyleSheet(\'dark\'); return false;">DARK</a>\n'
        retval += '                            &nbsp;\n'
        retval += '                            <a href=\'#\' onclick="setActiveStyleSheet(\'light\'); return false;">LIGHT</a>\n'
        retval += '                        </td>\n'
        retval += '                    </tr>\n'
        retval += '                </table>\n'
        retval += '                <br />\n'
        retval += '            </div>\n'
        retval += '''

        </div> <!-- Outermost -->
    </body>
        '''

        return retval

# Sru2Html
#
class Sru2Html(StdApp):
    # __init__
    #
    def __init__(self):
        StdApp.__init__(self)
        self.defaults = {}

    # initialize
    #
    def initialize(self):
        self.dbg('core', "initialize: enter\n")
        self.dbg('core', "initialize: leave\n")
        return

    # main
    #
    def main(self):
        cmdline = Cmdline()
        try:
            self.merge_config_options(self.defaults, cmdline.process(argv, self.defaults))
            cmdline.verify_options(self.cfg)

            self.initialize()

            if path.exists(self.cfg['sru']):
                with open(self.cfg['sru'], 'r') as f:
                    sru = json.load(f)

            #report = str(SruReport(sru))
            #print(report.encode("utf-8"))
            #print(str(SruReport(sru)).encode("utf-8"))
            print(SruReport(sru))

        # Handle the user presses <ctrl-C>.
        #
        except KeyboardInterrupt:
            pass

        # Handle ommand line errors.
        #
        except CmdlineError as e:
            cmdline.error(e.msg, self.defaults)

        return

if __name__ == '__main__':
    app = Sru2Html()
    app.main()

# vi:set ts=4 sw=4 expandtab:

